name: novnc-lxde-tailscale

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t novnc-lxde:latest .

      - name: Run container with Tailscale + noVNC
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          # Start container
          docker run -d --privileged --name novnc \
            --tmpfs /run --tmpfs /tmp \
            -e TAILSCALE_AUTHKEY=$TAILSCALE_AUTHKEY \
            novnc-lxde:latest

          # Start tailscaled
          docker exec -d novnc tailscaled
          sleep 5

          # Bring Tailscale up
          docker exec novnc tailscale up --authkey=$TAILSCALE_AUTHKEY --hostname=novnc-lxde

          # Grab the IPv4 address from Tailscale
          TS_IP=$(docker exec novnc tailscale ip -4 | head -n1)

          echo "---------------------------------------"
          echo "âœ… Access your desktop via noVNC:"
          echo "ðŸ”— http://$TS_IP:6080"
          echo "---------------------------------------"
