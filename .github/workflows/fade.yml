name: novnc-tailscale-xfce

on:
  workflow_dispatch:

jobs:
  desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read

    env:
      DEBIAN_FRONTEND: noninteractive

    steps:
      - name: Install xfce, TigerVNC, noVNC, Tailscale
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            tigervnc-standalone-server \
            novnc websockify python3-websockify \
            xfce4 xfce4-goodies xfce4-session curl openssl dbus-x11
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

          # Create user
          sudo useradd -m -s /bin/bash dev
          echo "dev:dev" | sudo chpasswd
          echo "dev ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/90-dev
          
          # Random VNC password
          RANDPW=$(openssl rand -base64 12 | tr -dc A-Za-z0-9 | head -c12)
          sudo -u dev mkdir -p /home/dev/.vnc
          printf "%s\n%s\n\n" "$RANDPW" "$RANDPW" | sudo -u dev vncpasswd
          echo "$RANDPW" | sudo tee /home/dev/.vnc/current_vnc_password >/dev/null
          sudo chmod 600 /home/dev/.vnc/current_vnc_password

          # Minimal xstartup (for XFCE)
          sudo -u dev bash -lc "cat > ~/.vnc/xstartup <<'EOF'
          #!/bin/sh
          # Unset variables
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          
          # Set necessary environment variables for XFCE
          export XDG_SESSION_TYPE=x11
          export XDG_SESSION_CLASS=user
          export XDG_CURRENT_DESKTOP=XFCE
          export XDG_CONFIG_DIRS="/etc/xdg"
          
          # Start D-Bus session if it's not already running
          if ! pgrep -x "dbus-daemon" > /dev/null; then
              eval $(/usr/bin/dbus-launch --sh-syntax --exit-with-session)
          fi
          
          # Start XFCE session
          startxfce4 &
          EOF
          chmod +x ~/.vnc/xstartup"

          # Install Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo systemctl enable --now tailscaled

          # Start VNC (localhost only, for noVNC)
          sudo -u dev vncserver :1 -localhost yes -geometry 1280x800 -SecurityTypes VncAuth

      - name: Tailscale up (IPv4 only)
        run: |
          sudo tailscale up \
            --auth-key=${{ secrets.TAILSCALE_AUTHKEY }} \
            --hostname=gh-xfce-$(date +%s) \
            --ssh \
            --accept-routes \
            --accept-dns=true

          echo "===================================================="
          echo "üåê noVNC URL: http://$(tailscale ip -4):6080/vnc.html"
          echo "üîë Password: $(sudo cat /home/dev/.vnc/current_vnc_password)"
          echo "===================================================="

      - name: Launch noVNC proxy
        run: |
          /usr/share/novnc/utils/novnc_proxy \
            --vnc localhost:5901 \
            --listen 0.0.0.0:6080 \
            --web /usr/share/novnc &

      - name: Keep session alive (6h)
        run: |
          echo "Keeping alive for 6 hours..."
          sleep 360m
