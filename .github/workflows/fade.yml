name: fade

on:
  workflow_dispatch:

jobs:
  ubuntu:
    runs-on: ubuntu-latest
    steps:
      - name: Install desktop + noVNC + Tailscale
        run: |
          sudo apt update
          sudo apt install -y curl gnupg lsb-release \
              xfce4 xfce4-goodies \
              tigervnc-standalone-server tigervnc-common \
              novnc python3-websockify firefox

          # Add Tailscale repo
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/$(lsb_release -cs).noarmor.gpg | \
            sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/$(lsb_release -cs).tailscale-keyring.list | \
            sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null

          sudo apt update
          sudo apt install -y tailscale

      - name: Add user
        run: |
          sudo useradd -m fade || true
          echo "fade:fade" | sudo chpasswd
          sudo usermod -aG sudo fade

      - name: Configure VNC xstartup
        run: |
          sudo -u fade mkdir -p /home/fade/.vnc
          cat <<'EOF' | sudo tee /home/fade/.vnc/xstartup
#!/bin/bash
unset SESSION_MANAGER
unset DBUS_SESSION_BUS_ADDRESS
exec startxfce4 &
EOF
          sudo chmod +x /home/fade/.vnc/xstartup
          sudo chown -R fade:fade /home/fade/.vnc

      - name: Start VNC backend
        run: |
          sudo -u fade vncserver -geometry 1280x800 -depth 24 :1
          echo "VNC server started on :1 (5901)"

      - name: Start noVNC
        run: |
          websockify --web=/usr/share/novnc/ --wrap-mode=ignore 0.0.0.0:6080 localhost:5901 &
          echo "noVNC running at http://<your-tailscale-ip>:6080/vnc.html"

      - name: Start Tailscale
        run: |
          sudo tailscaled --tun=userspace-networking --socks5-server=localhost:1055 &
          sleep 5
          sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --hostname fade
