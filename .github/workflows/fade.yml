name: fade

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

jobs:
  vps-session:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours
    container:
      image: jrei/systemd-ubuntu:24.04
      options: --privileged  # needed for full systemd

    steps:
      - name: System update
        run: |
          apt update

      - name: Install desktop + noVNC (LXDE only)
        run: |
          DEBIAN_FRONTEND=noninteractive apt install -y \
              lxde-core lxterminal \
              tigervnc-standalone-server tigervnc-common \
              novnc python3-websockify \
              dbus-x11 xdg-utils xdg-user-dirs \
              xdg-desktop-portal xdg-desktop-portal-gtk \
              software-properties-common wget systemd

      - name: Install Firefox (Snap version)
        run: |
          snap install firefox

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Add user
        run: |
          useradd -m fade || true
          echo "fade:fade" | chpasswd
          usermod -aG sudo fade

      - name: Configure systemd user session + VNC xstartup
        run: |
          sudo -u fade mkdir -p /home/fade/.vnc
          cat <<'EOF' > /home/fade/.vnc/xstartup
          #!/bin/sh
          export XDG_RUNTIME_DIR=/run/user/$(id -u)
          mkdir -p "$XDG_RUNTIME_DIR"
          chmod 700 "$XDG_RUNTIME_DIR"

          # Start dbus session bus
          if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
            eval $(dbus-launch --sh-syntax)
          fi

          # Fake login/session vars
          export XDG_SESSION_TYPE=x11
          export XDG_CURRENT_DESKTOP=lxde
          export XDG_SESSION_CLASS=user
          export XDG_SEAT=seat0

          # Import env into systemd user session
          systemctl --user import-environment DISPLAY XDG_RUNTIME_DIR DBUS_SESSION_BUS_ADDRESS || true

          # Start LXDE
          exec startlxde
          EOF
          chmod +x /home/fade/.vnc/xstartup
          chown -R fade:fade /home/fade/.vnc

      - name: Set VNC password
        run: |
          echo "fade" | vncpasswd -f > /home/fade/.vnc/passwd
          chown fade:fade /home/fade/.vnc/passwd
          chmod 600 /home/fade/.vnc/passwd

      - name: Start VNC backend
        run: |
          cd /home/fade
          sudo -u fade vncserver -geometry 1280x800 -depth 24 :1
          echo "‚úÖ VNC server started on :1 (port 5901)"

      - name: Start Tailscale
        run: |
          tailscaled --tun=userspace-networking --socks5-server=localhost:1055 &
          sleep 5
          tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --hostname fade

      - name: Start noVNC
        run: |
          websockify --web=/usr/share/novnc/ --wrap-mode=ignore 0.0.0.0:6080 localhost:5901 &
          TS_IP=$(tailscale ip -4 | head -n1 || echo "<your-tailscale-ip>")
          echo "üåê noVNC running at http://$TS_IP:6080/vnc.html"

      - name: Keep alive
        run: sleep 21600
