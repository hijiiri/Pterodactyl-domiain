name: novnc-tailscale-systemd

on:
  workflow_dispatch:

jobs:
  desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    steps:
      - name: Start systemd container (privileged)
        run: |
          set -eux
          docker pull jrei/systemd-ubuntu:22.04
          docker run -d --name sysd \
            --privileged \
            --cgroupns=host \
            -v /sys/fs/cgroup:/sys/fs/cgroup:rw \
            -p 6080:6080 \
            jrei/systemd-ubuntu:22.04
          sleep 4
          docker exec sysd bash -lc 'ps -p 1 -o comm='

      - name: Install XFCE, TigerVNC, noVNC, Tailscale
        run: |
          set -euxo pipefail
          docker exec sysd bash -euxo pipefail -c '
            export DEBIAN_FRONTEND=noninteractive

            apt-get update -qq
            apt-get install -y -qq \
              systemd systemd-sysv dbus dbus-user-session \
              sudo curl ca-certificates gnupg openssl \
              tigervnc-standalone-server \
              novnc websockify python3-websockify \
              xfce4 xfce4-terminal thunar \
              iproute2 iputils-ping
            apt-get clean
            rm -rf /var/lib/apt/lists/*

            # Create user
            useradd -m -s /bin/bash dev
            echo "dev:dev" | chpasswd
            usermod -aG sudo dev
            echo "dev ALL=(ALL) NOPASSWD:ALL" >/etc/sudoers.d/90-dev

            # Random 12-char alphanumeric VNC password
            RANDPW=$(openssl rand -base64 12 | tr -dc A-Za-z0-9 | head -c12)
            sudo -u dev mkdir -p /home/dev/.vnc
            printf "%s\n%s\n\n" "$RANDPW" "$RANDPW" | sudo -u dev /usr/bin/vncpasswd
            echo "$RANDPW" >/home/dev/.vnc/current_vnc_password
            chmod 600 /home/dev/.vnc/current_vnc_password

            # XFCE startup
            sudo -u dev bash -lc "echo -e \"#!/bin/sh\nstartxfce4 &\" > ~/.vnc/xstartup && chmod +x ~/.vnc/xstartup"

            # Install Tailscale
            curl -fsSL https://tailscale.com/install.sh | sh

            # Enable systemd essentials
            systemctl start dbus
            systemctl start systemd-logind
            systemctl enable --now tailscaled

            # Start VNC server manually
            sudo -u dev vncserver :1 -localhost no -geometry 1280x800 -SecurityTypes VncAuth
          '
      - name: Install Firefox
        run: |
          set -euxo pipefail
          docker exec sysd bash -lc '
            cd /opt
            wget -O firefox.tar.xz 'https://download.mozilla.org/?product=firefox-latest&os=linux64&lang=en-US'
            tar -xf firefox.tar.xz
            ln -sf /opt/firefox/firefox /usr/bin/firefox
          '
      - name: Tailscale up (IPv4 only)
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          set -euxo pipefail
          docker exec sysd bash -lc '
            tailscale up \
              --auth-key="${TAILSCALE_AUTHKEY}" \
              --hostname=gh-xfce-$(date +%s) \
              --ssh \
              --accept-routes \
              --accept-dns=true
          '

          TS_IP=$(docker exec sysd tailscale ip -4)

          echo "===================================================="
          echo "ðŸŒ noVNC URL: http://$TS_IP:6080/vnc.html"
          echo "ðŸ–¥  VNC Client: $TS_IP:5901"
          echo "ðŸ”‘ Password: $(docker exec sysd cat /home/dev/.vnc/current_vnc_password)"
          echo "===================================================="

          docker exec sysd loginctl

      - name: Launch noVNC proxy
        run: |
          docker exec -d sysd bash -lc '
            nohup /usr/share/novnc/utils/launch.sh \
              --vnc localhost:5901 \
              --listen 0.0.0.0:6080 \
              --web /usr/share/novnc > /var/log/novnc.log 2>&1 &
          '

      - name: Keep session alive (6h)
        run: |
          echo "Keeping container alive for 6 hours..."
          sleep 360m
