name: noVNC over Tailscale (6h)

on:
  workflow_dispatch:

jobs:
  novnc:
    runs-on: ubuntu-latest
    timeout-minutes: 360   # max 6h
    env:
      DEBIAN_FRONTEND: noninteractive

    steps:
      - name: Show runner info
        run: |
          echo "Runner: $(uname -a)"
          echo "Date: $(date -Is)"

      - name: Fast apt install
        run: |
          sudo bash -euxo pipefail -c '
            apt-get -o Acquire::Retries=3 -o Acquire::http::No-Cache=true update -y -qq
            apt-get install -y -qq --no-install-recommends \
              xvfb x11vnc fluxbox novnc websockify curl ca-certificates dbus jq coreutils openssl
            apt-get clean
          '

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start tailscaled (userspace networking only)
        run: |
          sudo nohup tailscaled --state=mem: --tun=userspace-networking >/tmp/tailscaled.log 2>&1 &
          sleep 2
          sudo tailscale up \
            --authkey "${{ secrets.TAILSCALE_AUTHKEY }}" \
            --hostname "gha-novnc-${{ github.run_id }}" \
            --accept-dns=false \
            --ssh=false

      - name: Generate random VNC password
        id: vncpass
        run: |
          VNC_PASS="$(openssl rand -base64 24 | tr -dc "A-Za-z0-9" | head -c 14)"
          echo "::add-mask::$VNC_PASS"
          mkdir -p "$HOME/.vnc"
          x11vnc -storepasswd "$VNC_PASS" "$HOME/.vnc/passwd"
          echo "pass=$VNC_PASS" >> $GITHUB_OUTPUT

      - name: Start Xvfb + fluxbox
        run: |
          export DISPLAY=:0
          nohup Xvfb :0 -screen 0 1280x800x24 >/tmp/xvfb.log 2>&1 &
          nohup fluxbox >/tmp/fluxbox.log 2>&1 &
          sleep 2

      - name: Start VNC server
        run: |
          export DISPLAY=:0
          nohup x11vnc -display :0 \
            -rfbauth "$HOME/.vnc/passwd" \
            -forever -shared -rfbport 5900 \
            -o /tmp/x11vnc.log >/tmp/x11vnc.out 2>&1 &

      - name: Start noVNC (websockify proxy on :6080)
        run: |
          NOVNC_LAUNCH="/usr/share/novnc/utils/launch.sh"
          test -x "$NOVNC_LAUNCH" || NOVNC_LAUNCH="/usr/share/novnc/utils/novnc_proxy"
          nohup "$NOVNC_LAUNCH" --listen 6080 --vnc localhost:5900 >/tmp/novnc.log 2>&1 &

      - name: Get Tailscale IPv4 + print connection info
        run: |
          TS_IPv4="$(tailscale ip -4 | head -n1)"
          echo "======================== Connection Details ========================"
          echo "noVNC URL:  http://$TS_IPv4:6080/vnc.html?autoconnect=true"
          echo "VNC Password: ${{ steps.vncpass.outputs.pass }}"
          echo "Session will be available for ~6 hours."
          echo "==================================================================="

      - name: Keep session alive for 6h
        run: sleep $((6*60*60))
