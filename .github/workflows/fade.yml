name: fade

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

jobs:
  vps-session:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours

    steps:
      - name: System upgrade
        run: |
          sudo apt update
          sudo apt upgrade -y
          sudo apt autoremove -y

      - name: Install desktop + noVNC + portals
        run: |
          sudo apt install -y lxde dbus-x11 systemd \
              tigervnc-standalone-server tigervnc-common \
              novnc python3-websockify software-properties-common \
              xdg-desktop-portal xdg-desktop-portal-gtk

      - name: Install Firefox (Deb version, not Snap)
        run: |
          sudo snap remove firefox || true
          sudo add-apt-repository -y ppa:mozillateam/ppa
          echo 'Package: firefox*' | sudo tee /etc/apt/preferences.d/mozillateamppa
          echo 'Pin: release o=LP-PPA-mozillateam' | sudo tee -a /etc/apt/preferences.d/mozillateamppa
          echo 'Pin-Priority: 501' | sudo tee -a /etc/apt/preferences.d/mozillateamppa
          sudo apt update
          sudo apt install -y firefox

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Add user
        run: |
          sudo useradd -m fade || true
          echo "fade:fade" | sudo chpasswd
          sudo usermod -aG sudo fade
          # Prepare runtime dir for systemd user services
          sudo mkdir -p /run/user/1001
          sudo chown fade:fade /run/user/1001
          sudo chmod 700 /run/user/1001

      - name: Configure VNC xstartup
        run: |
          sudo -u fade mkdir -p /home/fade/.vnc
          cat <<'EOF' | sudo tee /home/fade/.vnc/xstartup
          #!/bin/sh
          export XDG_RUNTIME_DIR=/run/user/$(id -u)
          systemctl --user import-environment DISPLAY XDG_RUNTIME_DIR
          dbus-update-activation-environment --systemd DISPLAY XDG_RUNTIME_DIR
          exec startlxde
          EOF
          sudo chmod +x /home/fade/.vnc/xstartup
          sudo chown -R fade:fade /home/fade/.vnc

      - name: Set VNC password
        run: |
          echo "fade" | vncpasswd -f > /home/fade/.vnc/passwd
          sudo chown fade:fade /home/fade/.vnc/passwd
          sudo chmod 600 /home/fade/.vnc/passwd

      - name: Start systemd --user session for fade
        run: |
          sudo -u fade dbus-launch --exit-with-session systemd --user &
          sleep 3
          echo "‚úÖ systemd user session started for fade"

      - name: Start VNC backend
        run: |
          cd /home/fade
          sudo -u fade vncserver -geometry 1280x800 -depth 24 :1
          echo "‚úÖ VNC server started on :1 (port 5901)"

      - name: Start noVNC
        run: |
          websockify --web=/usr/share/novnc/ --wrap-mode=ignore 0.0.0.0:6080 localhost:5901 &
          echo "üåê noVNC started"

      - name: Start Tailscale + Print Access URL
        run: |
          sudo tailscaled --tun=userspace-networking --socks5-server=localhost:1055 &
          sleep 5
          sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --hostname fade
          TAILSCALE_IP=$(tailscale ip -4 | head -n1)
          echo "üåê Access your desktop at: http://$TAILSCALE_IP:6080/vnc.html"

      - name: Keep alive
        run: sleep 21600
